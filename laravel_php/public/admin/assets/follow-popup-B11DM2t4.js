import{e as je,i as He,L as Pe,M as Ge,D as ze,B as qe,O as Ke,P as Qe,C as Je,_ as We,F as Xe,G as Ze,H as et,Q as tt,E as $}from"./element-plus-Dexv8m38.js";import{d as lt,m as ot,n as st,o as at,b as nt}from"./consumer-B-5sexIM.js";import{h as rt}from"./hospital-BeBKXzQO.js";import{a as it,d as ut}from"./index-RwF53efZ.js";import{d as ct,b,r as m,a0 as ie,w as K,at as dt,K as g,o as n,u as s,i as U,L as r,a as d,U as o,R as x,c,T as k,ab as V,O as pt,S as C,P as ue,M as _t}from"./@vue-ygbFPFRc.js";import"./@element-plus-X4lX9UBP.js";import"./lodash-es-C1lm3Iro.js";import"./dayjs-Bnps4p3p.js";import"./@popperjs-D_chPuIy.js";import"./async-validator-9PlIezaS.js";import"./@ctrl-r5W6hzzQ.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./nprogress-UhqZPtFR.js";import"./vue-router-Cg6aTb_d.js";import"./pinia-CfRoOCaL.js";import"./axios-DIsA03vz.js";import"./lodash-CMKdTQec.js";import"./@vueuse-yz9uDhpq.js";import"./css-color-function-rr4n3v1N.js";import"./balanced-match-BdS7OldZ.js";import"./color-DYO1E7y4.js";import"./clone-Ddk2tjDh.js";import"./color-convert-DsNsD289.js";import"./color-name-Dju3oUBS.js";import"./color-string-pUQDDJII.js";import"./ms-CzQ2E3wO.js";import"./vue-clipboard3-BWi338pc.js";import"./clipboard-7pJsftR6.js";import"./echarts-CXZcVnUo.js";import"./tslib-BDyQ-Jie.js";import"./zrender-DO4NV0px.js";import"./highlight.js-BLB-XFKK.js";import"./@highlightjs-DS9t1Xn3.js";const mt={class:"follow-panel"},ft={class:"panel-header"},vt={class:"tab-bar"},ht=["onClick"],yt={class:"tab-body"},bt={key:0,class:"follow-form"},wt={class:"hospital-box"},gt={key:0,class:"hospital-grid"},xt={class:"hospital-name"},kt={key:1,class:"hospital-empty"},Vt={class:"form-actions"},Ct={key:1,class:"dispatch-panel"},Et={class:"dispatch-add"},Dt={class:"dispatch-hospitals"},Ot={key:0,class:"hospital-grid"},Tt={class:"hospital-name"},St={key:1,class:"hospital-empty"},Lt={class:"dispatch-actions"},$t={key:2,class:"visit-panel"},Ut={key:3,class:"follow-timeline"},It={key:0,class:"empty"},Nt={key:1},Ft={class:"timeline-content"},At={class:"timeline-header"},Mt={class:"timeline-time"},Bt={key:0,class:"timeline-stage"},Rt={class:"timeline-lines"},ce=`大群：
小群：`,de=`预算：
喜欢风格：
客户顾虑：
咨询对接情况：
最新动态：
下次跟进计划：`,Yt=ct({__name:"follow-popup",props:{customerId:{},relationType:{},stageOptions:{},customerTypeOptions:{}},emits:["success","close"],setup(pe,{expose:_e,emit:me}){const D=pe,fe=b(()=>D.relationType||""),Q=me,ve=it(),he=b(()=>{const e=ve.userInfo||{};return Number(e.employee_user_id||e.user_id||0)}),S=m(!1),M=m(!1),h=m("follow"),ye=[{label:"客户动态",value:"dynamic"},{label:"咨询跟进动态",value:"consult"},{label:"客户跟进",value:"follow"},{label:"派单管理",value:"dispatch"},{label:"到诊管理",value:"visit"}],_=ie({}),B=m([]),J=m(0),R=m([]),Y=m(!1),f=m(""),y=m(""),w=m([]),I=m([]),be=m([]),j=m(),L=m([]),we=b(()=>{const e=he.value;return e?(Array.isArray(_.assist_list)?_.assist_list:[]).some(a=>Number(a.id)===e):!1}),N=b(()=>fe.value==="assist"||we.value),i=ie({stage:"",group_chat:ce,consult_text:"",follow_way:1,next_follow_time:"",customer_type:"",content:de}),ge={stage:[{required:!0,message:"请选择跟进阶段",trigger:"change"}],follow_way:[{required:!0,message:"请选择跟进方式",trigger:"change"}]},xe=b(()=>[{nickname:_.real_name||_.nickname||"-",mobile:_.mobile||"-",project:_.project_items_desc||"-",create_time:_.create_time||"-",follow_count:J.value||0,last_follow_time:_.last_follow_time||"-",next_follow_time:_.next_follow_time||"-"}]),W=b(()=>{const e=String(_.hospital||"").trim();if(!e)return[];const t=e.split(/[\n,，、|]/).map(a=>a.trim()).filter(Boolean);return Array.from(new Set(t))}),ke=b(()=>{const e=new Map;return I.value.forEach(t=>{t.province&&e.set(t.province,!0)}),Array.from(e.keys())}),Ve=b(()=>{const e=new Map;return I.value.forEach(t=>{f.value&&t.province!==f.value||t.city&&e.set(t.city,!0)}),Array.from(e.keys())}),X=b(()=>{if(!f.value||!y.value)return[];const e=new Set,t=new Set;return R.value.forEach(a=>{a.hospital_id&&e.add(a.hospital_id),a.hospital_name&&t.add(a.hospital_name)}),I.value.filter(a=>!(f.value&&a.province!==f.value||y.value&&a.city!==y.value||e.has(a.id)||t.has(a.name)))}),H=async()=>{try{const e=await nt({customer_id:D.customerId});Object.assign(_,e);const t=Number(_.customer_type||0);t>0&&(i.customer_type=t);const a=Number(_.stage||0);a>0&&(i.stage=a),_.group_chat&&(i.group_chat=_.group_chat),i.follow_way=N.value?2:1}catch(e){console.error(e)}},Ce=()=>h.value==="dynamic"?"sales":h.value==="consult"?"blogger":"",F=async()=>{try{const e=Ce(),t=await lt({customer_id:D.customerId,type:e||void 0,page_no:1,page_size:50});B.value=(t==null?void 0:t.lists)||[],J.value=Number((t==null?void 0:t.count)||0)}catch(e){console.error(e)}},P=async()=>{try{const e=await ot({customer_id:D.customerId});R.value=(e==null?void 0:e.lists)||[],w.value=[]}catch(e){console.error(e)}},Z=async()=>{try{const e=await rt();I.value=e||[]}catch(e){console.error(e)}},Ee=()=>{i.consult_text=L.value.join("、")},G=()=>{f.value="",y.value="",w.value=[]},A=()=>{var e;(e=j.value)==null||e.clearValidate(),Object.assign(i,{stage:_.stage||"",group_chat:_.group_chat||ce,consult_text:"",follow_way:N.value?2:1,next_follow_time:"",customer_type:"",content:de}),L.value=[]},De=async()=>{if(!w.value.length){$.warning("请选择医院");return}Y.value=!0;try{await st({customer_id:D.customerId,hospital_ids:w.value}),$.success("保存成功"),G(),await P(),await H(),await F()}catch(e){$.error(e.msg||"保存失败")}finally{Y.value=!1}},Oe=async()=>{var e;await((e=j.value)==null?void 0:e.validate()),M.value=!0;try{await at({customer_id:D.customerId,stage:i.stage,customer_type:i.customer_type||0,group_chat:i.group_chat,consult_text:i.consult_text,consult_hospitals:L.value.join("、"),follow_way:i.follow_way,next_follow_time:i.next_follow_time,content:i.content}),$.success("跟进成功"),Q("success"),A(),await H(),await F()}catch(t){$.error(t.msg||"跟进失败")}finally{M.value=!1}},ee=()=>{A(),G(),S.value=!1,Q("close")},Te=(e="follow")=>{if(h.value=e,A(),G(),S.value=!0,H(),e==="dispatch"){P(),Z();return}F()};K(h,()=>{if(S.value){if(h.value==="dispatch"){P(),Z();return}F()}}),K(()=>f.value,()=>{y.value="",w.value=[]}),K(()=>y.value,()=>{w.value=[]});const z=e=>{const t=Number(e.record_type||0);if(t)return t;const a=e.content||"";return a.includes("新增平台咨询为")?2:a.includes("客户录入")?3:a.includes("追加派单医院")?4:1},q=e=>z(e)===2,Se=e=>z(e)===3,te=e=>z(e)===4,le=e=>q(e)||Se(e)||te(e)?"":e.stage>10?e.stage_desc||"":e.stage?`阶段${e.stage}：${e.stage_desc||""}`:e.stage_desc||"",Le=e=>e.value>10?e.label:`阶段${e.value}：${e.label}`,$e={1:"A类客户:30天内要面诊或手术的客户",2:"B类客户:中远期要做，且粘性保持不错的客户",3:"C类客户:客户粘性一般，有机会可以做推动",4:"D类客户:客户基本不回复或被删除且无法再次绑定",5:"已手术客户:持续跟进，引导客户持续复购"},Ue=b(()=>D.customerTypeOptions.map(e=>({...e,label:$e[Number(e.value)]||e.label}))),Ie=e=>e.operator_name||e.operator_type_desc||"系统",oe=e=>e?e.split(/\n/).map(t=>t.trim()).filter(Boolean):[],Ne=e=>{const t=["dynamic","consult"].includes(h.value);if(t&&te(e))return oe(e.content||"");if(t&&!q(e)){const u=Ie(e),p=oe(e.content||""),v=[];if(!p.length)v.push(`${u}新建一条跟进记录：【无】`);else if(p.length===1)v.push(`${u}新建一条跟进记录：【${p[0]}】`);else{v.push(`${u}新建一条跟进记录：【${p[0]}`);for(let T=1;T<p.length-1;T++)v.push(p[T]);v.push(`${p[p.length-1]}】`)}const O=e.consult_hospitals||e.consult_text||"";return Number(e.consult_selected||0)&&O&&v.push(`所推咨询：${O}`),v}const a=[];return e.group_chat&&e.group_chat.split(/\n/).forEach(u=>{const p=u.trim();p&&a.push(p)}),e.consult_text&&a.push(`所推咨询：${e.consult_text}`),e.follow_way_desc&&!q(e)&&a.push(`跟进方式：${e.follow_way_desc}`),e.content&&e.content.split(/\n/).forEach(u=>{const p=u.trim();p&&a.push(p)}),e.next_follow_time&&a.push(`下次跟进时间：${e.next_follow_time}`),a};return _e({open:Te}),(e,t)=>{const a=He,u=Ge,p=Pe,v=Qe,O=Ke,E=qe,T=Je,se=Xe,ae=We,ne=et,Fe=Ze,Ae=tt,Me=ze,Be=je,Re=dt("perms");return n(),g(Be,{modelValue:s(S),"onUpdate:modelValue":t[11]||(t[11]=l=>U(S)?S.value=l:null),direction:"rtl",size:"50%","with-header":!1,"custom-class":"follow-drawer",onClose:ee},{default:r(()=>[d("div",mt,[d("div",ft,[t[13]||(t[13]=d("div",{class:"panel-title"},"客户信息",-1)),o(a,{class:"panel-close",text:"",onClick:ee},{default:r(()=>t[12]||(t[12]=[x("关闭")])),_:1})]),o(p,{data:s(xe),border:"",class:"info-table","header-cell-style":{background:"#f3f3f3",color:"#606266"}},{default:r(()=>[o(u,{label:"用户昵称",prop:"nickname","min-width":"120"}),o(u,{label:"手机号码",prop:"mobile","min-width":"120"}),o(u,{label:"报单项目",prop:"project","min-width":"100"}),o(u,{label:"报单时间",prop:"create_time","min-width":"140"}),o(u,{label:"跟进次数",prop:"follow_count","min-width":"80"}),o(u,{label:"最后跟进时间",prop:"last_follow_time","min-width":"140"}),o(u,{label:"下次跟进时间",prop:"next_follow_time","min-width":"140"})]),_:1},8,["data"]),d("div",vt,[(n(),c(k,null,V(ye,l=>d("button",{key:l.value,type:"button",class:pt(["tab-item",{active:s(h)===l.value}]),onClick:re=>h.value=l.value},C(l.label),11,ht)),64))]),d("div",yt,[s(h)==="follow"?(n(),c("div",bt,[o(Me,{ref_key:"formRef",ref:j,model:s(i),rules:ge,"label-width":"100px"},{default:r(()=>[o(E,{label:"客户阶段",prop:"stage"},{default:r(()=>[o(O,{modelValue:s(i).stage,"onUpdate:modelValue":t[0]||(t[0]=l=>s(i).stage=l),placeholder:"请选择阶段",class:"w-full"},{default:r(()=>[(n(!0),c(k,null,V(e.stageOptions,l=>(n(),g(v,{key:l.value,label:Le(l),value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(E,{label:"所在群聊",prop:"group_chat"},{default:r(()=>[o(T,{modelValue:s(i).group_chat,"onUpdate:modelValue":t[1]||(t[1]=l=>s(i).group_chat=l),type:"textarea",rows:3,placeholder:"请输入群聊信息"},null,8,["modelValue"])]),_:1}),o(E,{label:"所推咨询",prop:"consult_text"},{default:r(()=>[o(T,{modelValue:s(i).consult_text,"onUpdate:modelValue":t[2]||(t[2]=l=>s(i).consult_text=l),type:"textarea",rows:2,placeholder:"请输入所推咨询"},null,8,["modelValue"])]),_:1}),d("div",wt,[s(W).length?(n(),c("div",gt,[o(ae,{modelValue:s(L),"onUpdate:modelValue":t[3]||(t[3]=l=>U(L)?L.value=l:null),onChange:Ee},{default:r(()=>[(n(!0),c(k,null,V(s(W),l=>(n(),g(se,{key:l,label:l,class:"hospital-card"},{default:r(()=>[d("span",xt,C(l),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])):(n(),c("div",kt,"暂无报备医院"))]),o(E,{label:"跟进方式",prop:"follow_way"},{default:r(()=>[o(Fe,{modelValue:s(i).follow_way,"onUpdate:modelValue":t[4]||(t[4]=l=>s(i).follow_way=l),disabled:s(N)},{default:r(()=>[o(ne,{label:1},{default:r(()=>t[14]||(t[14]=[x("自己跟进")])),_:1}),s(N)?(n(),g(ne,{key:0,label:2},{default:r(()=>t[15]||(t[15]=[x("协助跟进")])),_:1})):ue("",!0)]),_:1},8,["modelValue","disabled"])]),_:1}),o(E,{label:"下次跟进时间",prop:"next_follow_time"},{default:r(()=>[o(Ae,{modelValue:s(i).next_follow_time,"onUpdate:modelValue":t[5]||(t[5]=l=>s(i).next_follow_time=l),type:"datetime",placeholder:"选择下次跟进时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss",class:"w-full"},null,8,["modelValue"])]),_:1}),o(E,{label:"客户类型",prop:"customer_type"},{default:r(()=>[o(O,{modelValue:s(i).customer_type,"onUpdate:modelValue":t[6]||(t[6]=l=>s(i).customer_type=l),placeholder:"请选择",clearable:"",class:"w-full"},{default:r(()=>[(n(!0),c(k,null,V(s(Ue),l=>(n(),g(v,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),o(E,{label:"跟进记录",prop:"content"},{default:r(()=>[o(T,{modelValue:s(i).content,"onUpdate:modelValue":t[7]||(t[7]=l=>s(i).content=l),type:"textarea",rows:6,placeholder:"请输入跟进记录"},null,8,["modelValue"])]),_:1}),d("div",Vt,[o(a,{onClick:A},{default:r(()=>t[16]||(t[16]=[x("重置")])),_:1}),o(a,{type:"primary",loading:s(M),onClick:Oe},{default:r(()=>t[17]||(t[17]=[x("提交")])),_:1},8,["loading"])])]),_:1},8,["model"])])):s(h)==="dispatch"?(n(),c("div",Ct,[t[20]||(t[20]=d("div",{class:"dispatch-title"},"派单医院：",-1)),o(p,{data:s(R),border:"",class:"dispatch-table","header-cell-style":{background:"#f3f3f3",color:"#606266"}},{default:r(()=>[o(u,{type:"index",label:"序号",width:"60"}),o(u,{label:"医院名称",prop:"hospital_name","min-width":"200"}),o(u,{label:"派单时间",prop:"dispatch_time","min-width":"160"}),o(u,{label:"状态信息","min-width":"120"},{default:r(({row:l})=>[x(C(l.status_desc||"-"),1)]),_:1}),o(u,{label:"最后反馈",prop:"last_feedback","min-width":"180"},{default:r(({row:l})=>[x(C(l.last_feedback||"-"),1)]),_:1})]),_:1},8,["data"]),d("div",Et,[o(a,{type:"primary",plain:""},{default:r(()=>t[18]||(t[18]=[x("追加派单")])),_:1}),o(O,{modelValue:s(f),"onUpdate:modelValue":t[8]||(t[8]=l=>U(f)?f.value=l:null),placeholder:"请选择省",clearable:"",class:"dispatch-select"},{default:r(()=>[(n(!0),c(k,null,V(s(ke),l=>(n(),g(v,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(O,{modelValue:s(y),"onUpdate:modelValue":t[9]||(t[9]=l=>U(y)?y.value=l:null),placeholder:"请选择市",clearable:"",class:"dispatch-select",disabled:!s(f)},{default:r(()=>[(n(!0),c(k,null,V(s(Ve),l=>(n(),g(v,{key:l,label:l,value:l},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),d("div",Dt,[s(X).length?(n(),c("div",Ot,[o(ae,{modelValue:s(w),"onUpdate:modelValue":t[10]||(t[10]=l=>U(w)?w.value=l:null)},{default:r(()=>[(n(!0),c(k,null,V(s(X),l=>(n(),g(se,{key:l.id,label:l.id,class:"hospital-card"},{default:r(()=>[d("span",Tt,C(l.name),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])):(n(),c("div",St,C(s(f)&&s(y)?"暂无可派单医院":"请先选择省市"),1))]),d("div",Lt,[_t((n(),g(a,{type:"primary",loading:s(Y),onClick:De},{default:r(()=>t[19]||(t[19]=[x(" 提交保存 ")])),_:1},8,["loading"])),[[Re,["user.user/dispatchAdd"]]])])])):s(h)==="visit"?(n(),c("div",$t,[t[21]||(t[21]=d("div",{class:"visit-title"},"消费详情：",-1)),o(p,{data:s(be),border:"",class:"visit-table","header-cell-style":{background:"#f3f3f3",color:"#606266"},"empty-text":"暂无数据!"},{default:r(()=>[o(u,{type:"index",label:"序号",width:"80"}),o(u,{label:"到诊医院",prop:"hospital_name","min-width":"160"}),o(u,{label:"到院时间",prop:"visit_time","min-width":"160"}),o(u,{label:"消费类型",prop:"consume_type","min-width":"140"}),o(u,{label:"消费项目",prop:"consume_item","min-width":"160"}),o(u,{label:"消费金额",prop:"consume_amount","min-width":"120"})]),_:1},8,["data"])])):(n(),c("div",Ut,[s(B).length?(n(),c("div",Nt,[(n(!0),c(k,null,V(s(B),l=>(n(),c("div",{key:l.id,class:"timeline-item"},[t[22]||(t[22]=d("div",{class:"timeline-dot"},null,-1)),d("div",Ft,[d("div",At,[d("div",Mt,C(l.create_time),1),le(l)?(n(),c("div",Bt,C(le(l)),1)):ue("",!0)]),d("div",Rt,[(n(!0),c(k,null,V(Ne(l),(re,Ye)=>(n(),c("div",{key:Ye,class:"line"},C(re),1))),128))])])]))),128))])):(n(),c("div",It,"暂无跟进记录"))]))])])]),_:1},8,["modelValue"])}}}),gl=ut(Yt,[["__scopeId","data-v-a914b9b1"]]);export{gl as default};
