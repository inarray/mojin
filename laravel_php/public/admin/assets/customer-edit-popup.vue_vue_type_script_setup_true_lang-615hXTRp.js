import{D as $,B as A,C as H,O as K,P as M,G as Z,H as q,Z as J,E as b}from"./element-plus-Dexv8m38.js";import{f as Q,b as W}from"./consumer-B-5sexIM.js";import{P as X}from"./index-CiZ7u30k.js";import{_ as Y}from"./picker-B75jrQ9B.js";import{r as ee}from"./region-china-BCkRz1Fn.js";import{d as le,r as y,a0 as C,b as oe,w as re,K as ne,o as N,L as u,U as n,u as t,c as ae,T as te,ab as se,R as h,i as ie}from"./@vue-ygbFPFRc.js";const ge=le({__name:"customer-edit-popup",props:{customerId:{}},emits:["success","close"],setup(O,{expose:D,emit:F}){const v=O,k=F,V=y(),x=y(),R=[{value:1,label:"小红书"},{value:2,label:"抖音"},{value:6,label:"快手"},{value:3,label:"微信"},{value:7,label:"发帖引流"},{value:8,label:"凯文抖音博主号"},{value:9,label:"七七团队素人账号"},{value:10,label:"不凡团队素人账号"},{value:4,label:"朋友介绍"},{value:5,label:"其他"}],f=()=>({avatar:"",real_name:"",mobile:"",wechat:"",source:"",source_account:"",sex:0,region_province:"",region_city:"",region_district:"",region_address:"",remark:""}),r=C(f()),w=C(f()),j={mobile:[{validator:(e,l,o)=>{if(!l)return o();if(!/^1[3-9]\d{9}$/.test(l))return o(new Error("手机号码格式错误"));o()},trigger:"blur"}]},m=e=>e.trim(),E=e=>({avatar:m(e.avatar||""),real_name:m(e.real_name||""),mobile:m(e.mobile||""),wechat:m(e.wechat||""),source:Number.isFinite(Number(e.source))&&Number(e.source)>0?Number(e.source):"",source_account:m(e.source_account||""),sex:Number(e.sex||0),region_province:m(e.region_province||""),region_city:m(e.region_city||""),region_district:m(e.region_district||""),region_address:m(e.region_address||""),remark:m(e.remark||"")}),B={avatar:"头像",real_name:"客户姓名",mobile:"联系号码",wechat:"微信号",source:"客户来源",source_account:"来源账号",sex:"性别",region_province:"客户地址",region_city:"客户地址",region_district:"客户地址",region_address:"详细地址",remark:"备注"},I=e=>{const l=Number(e.source||0);let o=e.region_province||"",s=e.region_city||"",p=e.region_district||"",d=e.region_address||"";if(!o&&!s&&!p&&e.region){const c=String(e.region).split(/\s+/).map(g=>g.trim()).filter(Boolean);o=c[0]||"",s=c[1]||"",p=c[2]||"",!d&&c.length>3&&(d=c.slice(3).join(" "))}const i={avatar:e.avatar||"",real_name:e.real_name||"",mobile:e.mobile||"",wechat:e.wechat||"",source:l>0?l:"",source_account:e.source_account||"",sex:Number(e.sex||0),region_province:o,region_city:s,region_district:p,region_address:d,remark:e.remark||""};Object.assign(r,i),Object.assign(w,i),_.value=[o,s,p].filter(Boolean)},S=async()=>{try{const e=await W({customer_id:v.customerId});I(e)}catch(e){console.error(e)}},P=()=>{const e=E(r),l=E(w),o=[];let s=null,p=!1;if(Object.keys(e).forEach(d=>{if(s)return;const i=d,c=e[i],g=l[i];if(c!==g){if(i==="source"&&c===""){s=i;return}if(typeof c=="string"&&c===""){s=i;return}o.push({field:i,value:c}),(i==="region_province"||i==="region_city"||i==="region_district"||i==="region_address")&&(p=!0)}}),s)return b.warning(`${B[s]}不能为空`),null;if(p){const d=[e.region_province,e.region_city,e.region_district,e.region_address].filter(Boolean).join(" ");d&&o.push({field:"region",value:d})}return o},T=()=>{var e;v.customerId&&((e=V.value)==null||e.open(),S())},L=async()=>{var l;await((l=x.value)==null?void 0:l.validate());const e=P();if(e){if(!e.length){b.info("未检测到可更新内容");return}try{await Q({id:v.customerId,fields:e}),b.success("保存成功"),k("success"),U()}catch(o){b.error(o.msg||"保存失败")}}},U=()=>{var e,l;(e=x.value)==null||e.clearValidate(),Object.assign(r,f()),Object.assign(w,f()),_.value=[],(l=V.value)==null||l.close(),k("close")},z=oe(()=>ee.map(e=>({label:e.label,value:e.value,children:(e.children||[]).map(l=>({label:l.label,value:l.value,children:(l.children||[]).map(o=>({label:o.label,value:o.value}))}))}))),_=y([]);return re(()=>_.value,e=>{r.region_province=(e==null?void 0:e[0])||"",r.region_city=(e==null?void 0:e[1])||"",r.region_district=(e==null?void 0:e[2])||""}),D({open:T}),(e,l)=>{const o=A,s=H,p=M,d=K,i=q,c=Z,g=J,G=$;return N(),ne(X,{ref_key:"popupRef",ref:V,title:"完善客户信息",async:!0,width:"560px",onConfirm:L,onClose:U},{default:u(()=>[n(G,{ref_key:"formRef",ref:x,model:t(r),rules:j,"label-width":"110px"},{default:u(()=>[n(o,{label:"头像",prop:"avatar"},{default:u(()=>[n(Y,{modelValue:t(r).avatar,"onUpdate:modelValue":l[0]||(l[0]=a=>t(r).avatar=a),limit:1},null,8,["modelValue"])]),_:1}),n(o,{label:"客户姓名",prop:"real_name"},{default:u(()=>[n(s,{modelValue:t(r).real_name,"onUpdate:modelValue":l[1]||(l[1]=a=>t(r).real_name=a),placeholder:"请输入客户姓名",maxlength:"32"},null,8,["modelValue"])]),_:1}),n(o,{label:"联系号码",prop:"mobile"},{default:u(()=>[n(s,{modelValue:t(r).mobile,"onUpdate:modelValue":l[2]||(l[2]=a=>t(r).mobile=a),placeholder:"请输入联系号码",maxlength:"11"},null,8,["modelValue"])]),_:1}),n(o,{label:"微信号",prop:"wechat"},{default:u(()=>[n(s,{modelValue:t(r).wechat,"onUpdate:modelValue":l[3]||(l[3]=a=>t(r).wechat=a),placeholder:"请输入微信号",maxlength:"32"},null,8,["modelValue"])]),_:1}),n(o,{label:"客户来源",prop:"source"},{default:u(()=>[n(d,{modelValue:t(r).source,"onUpdate:modelValue":l[4]||(l[4]=a=>t(r).source=a),placeholder:"请选择客户来源",clearable:"",class:"w-full"},{default:u(()=>[(N(),ae(te,null,se(R,a=>n(p,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),n(o,{label:"来源账号",prop:"source_account"},{default:u(()=>[n(s,{modelValue:t(r).source_account,"onUpdate:modelValue":l[5]||(l[5]=a=>t(r).source_account=a),placeholder:"请输入来源账号",maxlength:"64"},null,8,["modelValue"])]),_:1}),n(o,{label:"性别",prop:"sex"},{default:u(()=>[n(c,{modelValue:t(r).sex,"onUpdate:modelValue":l[6]||(l[6]=a=>t(r).sex=a)},{default:u(()=>[n(i,{label:0},{default:u(()=>l[10]||(l[10]=[h("未知")])),_:1}),n(i,{label:1},{default:u(()=>l[11]||(l[11]=[h("男")])),_:1}),n(i,{label:2},{default:u(()=>l[12]||(l[12]=[h("女")])),_:1})]),_:1},8,["modelValue"])]),_:1}),n(o,{label:"客户地址",prop:"region_province"},{default:u(()=>[n(g,{modelValue:t(_),"onUpdate:modelValue":l[7]||(l[7]=a=>ie(_)?_.value=a:null),options:t(z),props:{checkStrictly:!0,expandTrigger:"hover"},clearable:"",filterable:"",placeholder:"请选择省/市/区",class:"w-full"},null,8,["modelValue","options"])]),_:1}),n(o,{label:"详细地址",prop:"region_address"},{default:u(()=>[n(s,{modelValue:t(r).region_address,"onUpdate:modelValue":l[8]||(l[8]=a=>t(r).region_address=a),placeholder:"请输入详细地址",maxlength:"200"},null,8,["modelValue"])]),_:1}),n(o,{label:"备注",prop:"remark"},{default:u(()=>[n(s,{modelValue:t(r).remark,"onUpdate:modelValue":l[9]||(l[9]=a=>t(r).remark=a),type:"textarea",rows:"3",placeholder:"请输入备注",maxlength:"300","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},512)}}});export{ge as _};
